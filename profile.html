<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸ªäººä¸­å¿ƒ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
* { font-family: 'Inter', sans-serif; }
body { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; padding-bottom: 80px; }
.glass { background: rgba(102, 126, 234, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
.glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); }
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto; padding: 20px; }
.modal.show { display: block; }
.nav-glass { background: rgba(102, 126, 234, 0.95); backdrop-filter: blur(20px); border-top: 2px solid rgba(255, 255, 255, 0.5); }
</style>
</head>
<body>

<div class="glass sticky top-0 z-50">
<div class="max-w-md mx-auto px-4 py-6">
<div class="flex flex-col items-center gap-4">
<div class="w-24 h-24 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-5xl">ğŸ‘¤</div>
<div class="text-center">
<h1 class="text-xl font-bold text-white mb-1" id="username">æŠ•èµ„è€…</h1>
<p class="text-xs text-white/80 bg-white/20 px-3 py-1 rounded-full">ID: AI_2026</p>
</div>
</div>
</div>
</div>

<div class="max-w-md mx-auto px-4 py-4 space-y-4">

<div class="glass-card rounded-3xl p-5 shadow-xl">
<h2 class="text-base font-bold mb-3 flex items-center gap-2">
<span>ğŸŒ</span><span id="langTitle">è¯­è¨€è®¾ç½®</span>
</h2>
<div class="grid grid-cols-3 gap-3">
<button onclick="setLanguage('zh')" id="btnZh" class="py-3 rounded-xl font-bold transition-all">ä¸­æ–‡</button>
<button onclick="setLanguage('en')" id="btnEn" class="py-3 rounded-xl font-bold transition-all">English</button>
<button onclick="setLanguage('es')" id="btnEs" class="py-3 rounded-xl font-bold transition-all">EspaÃ±ol</button>
</div>
</div>

<div class="glass-card rounded-3xl p-5 shadow-xl">
<div class="flex justify-between items-center mb-3">
<h2 class="text-base font-bold flex items-center gap-2">
<span>ğŸ“Š</span><span id="historyTitle">å†å²æŠ¥å‘Š</span>
</h2>
<button onclick="loadHistory()" class="text-purple-600 text-xs font-semibold bg-purple-50 px-3 py-1 rounded-lg" id="refreshBtn">åˆ·æ–°</button>
</div>
<div id="historyList" class="space-y-3"></div>
</div>

</div>

<div id="modal" class="modal">
<div class="max-w-2xl mx-auto">
<div class="glass-card rounded-3xl p-6 mb-4">
<div class="flex justify-between items-center mb-6">
<h3 class="text-2xl font-bold text-purple-600" id="modalTitle">å®Œæ•´äº¤æ˜“å†³ç­–æŠ¥å‘Š</h3>
<button onclick="closeModal()" class="text-white bg-red-600 rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl hover:bg-red-700 transition-all">âœ•</button>
</div>
<div id="modalBody"></div>
</div>
</div>
</div>

<div class="fixed bottom-0 left-0 right-0 nav-glass z-50">
<div class="max-w-md mx-auto flex justify-around py-3">
<a href="index.html" class="flex flex-col items-center gap-1 py-2 px-4">
<svg class="w-6 h-6 text-white opacity-70" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
<span class="text-xs font-bold text-white opacity-70" id="navHome">é¦–é¡µ</span>
</a>
<a href="portfolio.html" class="flex flex-col items-center gap-1 py-2 px-4">
<svg class="w-6 h-6 text-white opacity-70" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/></svg>
<span class="text-xs font-bold text-white opacity-70" id="navAisight">æŠ•èµ„ç»„åˆ</span>
</a>
<a href="profile.html" class="flex flex-col items-center gap-1 py-2 px-4">
<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
<span class="text-xs font-bold text-white" id="navProfile">ä¸ªäººä¸­å¿ƒ</span>
</a>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/he/1.2.0/he.min.js"></script>
<script>
let currentLang = localStorage.getItem('language') || 'zh';

const translations = {
zh: { username: 'æŠ•èµ„è€…', langTitle: 'è¯­è¨€è®¾ç½®', historyTitle: 'å†å²æŠ¥å‘Š', refreshBtn: 'åˆ·æ–°', navHome: 'é¦–é¡µ', navAisight: 'æŠ•èµ„ç»„åˆ', navProfile: 'ä¸ªäººä¸­å¿ƒ', noHistory: 'æš‚æ— åˆ†æè®°å½•', noHistoryDesc: 'å‰å¾€é¦–é¡µå¼€å§‹åˆ†æ', modalTitle: 'å®Œæ•´äº¤æ˜“å†³ç­–æŠ¥å‘Š', holding: 'æŒä»“ä¿¡æ¯', noHolding: 'æœªæŒä»“', cost: 'æˆæœ¬', shares: 'æŒè‚¡', currentPrice: 'å½“å‰ä»·', marketValue: 'å¸‚å€¼', pnl: 'ç›ˆäº', summary: 'ä¸€å¥è¯æ€»ç»“', phase: 'å½“å‰é˜¶æ®µ', shortTerm: 'çŸ­æœŸå»ºè®®', midTerm: 'ä¸­æœŸå»ºè®®', longTerm: 'é•¿æœŸå»ºè®®', keyLevels: 'å…³é”®ä»·ä½', support: 'æ”¯æ’‘ä½', resistance: 'é˜»åŠ›ä½', buyPoints: 'ä¹°å…¥èŠ‚ç‚¹å»ºè®®', sellPoints: 'å–å‡ºæ—¶é—´èŠ‚ç‚¹å»ºè®®', risks: 'æ ¸å¿ƒé£é™©', expectedGains: 'é¢„æœŸæ¶¨è·Œå¹…', short: 'çŸ­æœŸ', mid: 'ä¸­æœŸ', long: 'é•¿æœŸ', analysisTime: 'åˆ†ææ—¶é—´', langChanged: 'è¯­è¨€å·²åˆ‡æ¢', viewReport: 'åœ¨çº¿æŸ¥çœ‹', downloadReport: 'ä¸‹è½½æŠ¥å‘Š' },
en: { username: 'Investor', langTitle: 'Language', historyTitle: 'History', refreshBtn: 'Refresh', navHome: 'Home', navAisight: 'Portfolio', navProfile: 'Profile', noHistory: 'No records', noHistoryDesc: 'Go to Home to start', modalTitle: 'Complete Trading Decision Report', holding: 'Holdings', noHolding: 'No Holdings', cost: 'Cost', shares: 'Shares', currentPrice: 'Current Price', marketValue: 'Market Value', pnl: 'P&L', summary: 'Summary', phase: 'Current Phase', shortTerm: 'Short-Term', midTerm: 'Mid-Term', longTerm: 'Long-Term', keyLevels: 'Key Levels', support: 'Support', resistance: 'Resistance', buyPoints: 'Buy Points', sellPoints: 'Sell Points', risks: 'Core Risks', expectedGains: 'Expected Gains', short: 'Short', mid: 'Mid', long: 'Long', analysisTime: 'Analysis Time', langChanged: 'Language changed', viewReport: 'View Report', downloadReport: 'Download Report' },
es: { username: 'Inversor', langTitle: 'Idioma', historyTitle: 'Historial', refreshBtn: 'Actualizar', navHome: 'Inicio', navAisight: 'Portafolio', navProfile: 'Perfil', noHistory: 'Sin registros', noHistoryDesc: 'Ir a Inicio para empezar', modalTitle: 'Informe Completo', holding: 'Posiciones', noHolding: 'Sin Posiciones', cost: 'Costo', shares: 'Acciones', currentPrice: 'Precio Actual', marketValue: 'Valor', pnl: 'G/P', summary: 'Resumen', phase: 'Fase Actual', shortTerm: 'Corto Plazo', midTerm: 'Medio Plazo', longTerm: 'Largo Plazo', keyLevels: 'Niveles Clave', support: 'Soporte', resistance: 'Resistencia', buyPoints: 'Puntos Compra', sellPoints: 'Puntos Venta', risks: 'Riesgos', expectedGains: 'Ganancias Esperadas', short: 'Corto', mid: 'Medio', long: 'Largo', analysisTime: 'Tiempo AnÃ¡lisis', langChanged: 'Idioma cambiado', viewReport: 'Ver Informe', downloadReport: 'Descargar' }
};

function applyLanguage() {
const t = translations[currentLang];
document.getElementById('username').textContent = t.username;
document.getElementById('langTitle').textContent = t.langTitle;
document.getElementById('historyTitle').textContent = t.historyTitle;
document.getElementById('refreshBtn').textContent = t.refreshBtn;
document.getElementById('navHome').textContent = t.navHome;
document.getElementById('navAisight').textContent = t.navAisight;
document.getElementById('navProfile').textContent = t.navProfile;

['zh','en','es'].forEach(lang => {
const btn = document.getElementById('btn' + lang.charAt(0).toUpperCase() + lang.slice(1));
btn.className = lang === currentLang 
? 'py-3 rounded-xl font-bold transition-all bg-gradient-to-r from-purple-600 to-pink-600 text-white'
: 'py-3 rounded-xl font-bold transition-all bg-gray-200 text-gray-600';
});
}

function setLanguage(lang) {
currentLang = lang;
localStorage.setItem('language', lang);
applyLanguage();
loadHistory();
}

function loadHistory() {
const t = translations[currentLang];
const analyses = JSON.parse(localStorage.getItem('stockAnalyses') || '[]');
const list = document.getElementById('historyList');

console.log('Loading history, found', analyses.length, 'analyses');

if (analyses.length === 0) {
list.innerHTML = `<div class="text-center py-8 text-gray-400">
<div class="text-4xl mb-2">ğŸ“Š</div>
<div class="text-sm">${t.noHistory}</div>
<div class="text-xs mt-2">${t.noHistoryDesc}</div>
</div>`;
return;
}

list.innerHTML = analyses.slice(0, 20).map((item, idx) => {
const d = item.data || {};
const isUp = (d.change || 0) >= 0;
const border = isUp ? 'border-green-500' : 'border-red-500';
const textColor = isUp ? 'text-green-600' : 'text-red-600';

return `
<div class="bg-white/90 rounded-2xl p-4 border-l-4 ${border}">
<div class="flex justify-between items-center mb-2">
<div class="font-bold text-lg text-purple-600">${item.symbol}</div>
<div class="text-xs text-gray-500">${item.date.split(' ')[0]}</div>
</div>
<div class="flex justify-between items-center mb-3">
<div class="text-2xl font-bold">$${d.price ? d.price.toFixed(2) : 'N/A'}</div>
<div class="${textColor} font-bold">${isUp ? '+' : ''}${d.changePercent || 'N/A'}</div>
</div>
<div class="grid grid-cols-2 gap-2">
<button onclick="viewDetail(${idx})" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-xl text-sm active:scale-95 transition-all flex items-center justify-center gap-2">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>
${t.viewReport}
</button>
<button onclick="downloadReport(${idx})" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-2 px-4 rounded-xl text-sm active:scale-95 transition-all flex items-center justify-center gap-2">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
${t.downloadReport}
</button>
</div>
</div>
`;
}).join('');
}

// ç”ŸæˆAIåˆ†æ - æ ¹æ®å½“å‰è¯­è¨€åŠ¨æ€ç”Ÿæˆ
function generateAnalysis(symbol, data, lang) {
const isUp = data.change >= 0;
const p = data.price;

if (lang === 'zh') {
return {
summary: `${symbol}å½“å‰å¤„äº${isUp?'ä¸Šæ¶¨':'è°ƒæ•´'}é˜¶æ®µï¼ŒæŠ€æœ¯é¢${isUp?'å¼ºåŠ²':'åå¼±'}ï¼Œå»ºè®®${isUp?'æŒæœ‰å¹¶å…³æ³¨å›è°ƒæœºä¼š':'ç­‰å¾…ä¼ç¨³ä¿¡å·'}`,
phase: `å½“å‰${isUp?'ä¸Šæ¶¨è¶‹åŠ¿':'è°ƒæ•´é˜¶æ®µ'}ï¼Œä»·æ ¼${isUp?'çªç ´':'è·Œç ´'}å…³é”®å‡çº¿ï¼Œæˆäº¤é‡${data.volume>50000000?'æ”¾å¤§':'èç¼©'}ï¼ŒMACD${isUp?'é‡‘å‰':'æ­»å‰'}ï¼ŒRSI${isUp?'70é™„è¿‘è¶…ä¹°':'35é™„è¿‘è¶…å–'}`,
shortTerm: `çŸ­æœŸ(1-4å‘¨)ï¼šç›®æ ‡$${(p*(isUp?1.08:0.95)).toFixed(2)}-$${(p*(isUp?1.12:0.98)).toFixed(2)}ã€‚${isUp?'å›è°ƒ$'+(p*0.97).toFixed(2)+'å¯åŠ ä»“30%':'è·Œç ´$'+(p*0.93).toFixed(2)+'æ­¢æŸ'}ã€‚è®¾ç½®${(p*(isUp?0.93:0.88)).toFixed(2)}æ­¢æŸä½ã€‚å»ºè®®${isUp?'70%':'30%'}æŒä»“`,
midTerm: `ä¸­æœŸ(1-3æœˆ)ï¼šç›®æ ‡$${(p*(isUp?1.18:0.88)).toFixed(2)}-$${(p*(isUp?1.25:0.92)).toFixed(2)}ã€‚å…³æ³¨ä¸‹æ¬¡è´¢æŠ¥(é¢„è®¡${isUp?'è¶…é¢„æœŸ':'ä½äºé¢„æœŸ'})ã€‚${isUp?'æŒæœ‰60%æ ¸å¿ƒä»“ä½ï¼Œ40%æ³¢æ®µæ“ä½œ':'è½»ä»“20%è§‚æœ›ï¼Œç­‰å¾…$'+(p*0.85).toFixed(2)+'å»ºä»“'}ã€‚è·Ÿè¸ªè´¢æŠ¥ã€ç«å“ã€æ”¿ç­–å˜åŒ–`,
longTerm: `é•¿æœŸ(3-12æœˆ)ï¼šç›®æ ‡$${(p*(isUp?1.35:0.75)).toFixed(2)}-$${(p*(isUp?1.50:0.85)).toFixed(2)}ã€‚${isUp?'è¡Œä¸šé¾™å¤´ç¨³å›ºï¼ŒæŠ€æœ¯æŠ¤åŸæ²³æ·±ï¼Œé•¿æœŸç¡®å®šæ€§é«˜':'çŸ­æœŸæ‰¿å‹ä½†åŸºæœ¬é¢æœªå˜ï¼Œä¼°å€¼å†å²ä½ä½ï¼Œé•¿æœŸé…ç½®ä»·å€¼'}ã€‚æ ¸å¿ƒ${isUp?'50%':'20%'}ï¼Œæ³¢æ®µ20%ï¼Œç°é‡‘${isUp?'30%':'60%'}ã€‚å…³æ³¨æŠ€æœ¯é©æ–°ã€å¸‚åœºä»½é¢ã€æ”¿ç­–ã€å®è§‚`,
buyPoints: [
`ä¹°ç‚¹1ï¼š$${(p*0.95).toFixed(2)}-$${(p*0.97).toFixed(2)} | 10æ—¥å‡çº¿æ”¯æ’‘ï¼ŒRSI50-60ï¼ŒMACDçº¢æŸ±ç¼©çŸ­ | åŠ ä»“20-30% | æ­¢æŸ$${(p*0.92).toFixed(2)}`,
`ä¹°ç‚¹2ï¼š$${(p*0.88).toFixed(2)}-$${(p*0.92).toFixed(2)} | 30æ—¥å‡çº¿æ”¯æ’‘ï¼Œè¶…å–ï¼Œæˆäº¤é‡èç¼©è§åº• | åˆ†æ‰¹30-40% | æ­¢æŸ$${(p*0.85).toFixed(2)}`,
`ä¹°ç‚¹3ï¼š$${(p*0.75).toFixed(2)}-$${(p*0.82).toFixed(2)} | ä¼°å€¼å†å²ä½ä½ï¼ŒåŸºæœ¬é¢æœªå˜ï¼Œé•¿æœŸé€»è¾‘æˆç«‹ | 3-6æœˆåˆ†æ‰¹50-60% | é•¿æœŸæŒæœ‰ä¸è®¾æ­¢æŸ`
],
sellPoints: [
`å–ç‚¹1ï¼š$${(p*1.08).toFixed(2)}-$${(p*1.12).toFixed(2)} | çªç ´å‰é«˜ï¼ŒRSI>70ï¼ŒMACDèƒŒç¦» | å–30%é”å®šåˆ©æ¶¦ | æŠ€æœ¯é¢è¿‡çƒ­éœ€æ•´ç†`,
`å–ç‚¹2ï¼š$${(p*1.20).toFixed(2)}-$${(p*1.28).toFixed(2)} | è´¢æŠ¥åä¼°å€¼ä¿®å¤ï¼Œæƒ…ç»ªé«˜æ¶¨ | å–40%ä¿ç•™æ ¸å¿ƒ | ä¼°å€¼å……åˆ†åæ˜ åˆ©å¥½`,
`å–ç‚¹3ï¼š$${(p*1.40).toFixed(2)}-$${(p*1.55).toFixed(2)} | é•¿æœŸç›®æ ‡è¾¾æˆï¼ŒåŸºæœ¬é¢/æŠ€æœ¯æ‹ç‚¹ | å‡è‡³20-30%åº•ä»“ | é˜²èŒƒç³»ç»Ÿæ€§é£é™©`
],
supports: [
`æ”¯æ’‘1ï¼š$${(p*0.95).toFixed(2)} | 10æ—¥å‡çº¿ï¼Œå‰æœŸå¯†é›†åŒºï¼Œ0.382å›æ’¤ | å¼ºæ”¯æ’‘è·Œç ´30% | ä¼ç¨³å¯åŠ ä»“`,
`æ”¯æ’‘2ï¼š$${(p*0.88).toFixed(2)} | 30æ—¥å‡çº¿ï¼Œå¹³å°åº•éƒ¨ï¼Œ0.618å›æ’¤ | å¼ºæ”¯æ’‘è·Œç ´15% | ä¸­æœŸä¹°ç‚¹`
],
resistances: [
`é˜»åŠ›1ï¼š$${(p*1.08).toFixed(2)} | å‰é«˜ï¼Œé€šé“ä¸Šè½¨ï¼Œæ•´æ•°å…³å£ | ä¸­ç­‰é˜»åŠ›çªç ´45% | å¯è¿½æ¶¨`,
`é˜»åŠ›2ï¼š$${(p*1.18).toFixed(2)} | å†å²é«˜ç‚¹ï¼Œå¯†é›†åŒºï¼Œé¢ˆçº¿ä½ | å¼ºé˜»åŠ›çªç ´25% | éœ€æ”¾é‡ç¡®è®¤`
],
risks: [
`é£é™©1ï¼šå¸‚åœºç³»ç»Ÿæ€§é£é™© | ç¾è”å‚¨åŠ æ¯è¶…é¢„æœŸï¼ŒæµåŠ¨æ€§æ”¶ç´§ï¼Œç§‘æŠ€è‚¡æ‰¿å‹ | æ¦‚ç‡35% | å½±å“-10è‡³-15% | é™ä»“è‡³50%ä»¥ä¸‹ï¼Œå…³æ³¨è®®æ¯ä¼šè®®`,
`é£é™©2ï¼šè¡Œä¸šç«äº‰åŠ å‰§ | æ–°è¿›å…¥è€…çªç ´æˆ–ç«å“ä»½é¢æ‰©å¤§ï¼Œåˆ©æ¶¦ç‡ä¸‹é™ | æ¦‚ç‡30% | å½±å“å¢é€Ÿ-5è‡³-10% | å…³æ³¨ç«å“åŠ¨æ€å’Œè´¢æŠ¥å¸‚å ç‡`,
`é£é™©3ï¼šåŸºæœ¬é¢æ¶åŒ– | äº§å“ç ”å‘ä¸åŠé¢„æœŸæˆ–å¤§å®¢æˆ·æµå¤±ï¼Œè¥æ”¶ä¸‹æ»‘ | æ¦‚ç‡20% | å½±å“ä¼°å€¼-15è‡³-20% | è·Ÿè¸ªå­£åº¦ä¸šç»©å’Œç®¡ç†å±‚æŒ‡å¼•`
],
expectedGains: { short: isUp?'+8%':'-5%', mid: isUp?'+18%':'+8%', long: isUp?'+35%':'+25%' }
};
} else if (lang === 'es') {
return {
summary: `${symbol} en fase de ${isUp?'subida':'ajuste'}, tÃ©cnicos ${isUp?'fuertes':'dÃ©biles'}, se recomienda ${isUp?'mantener y observar retroceso':'esperar seÃ±al de estabilizaciÃ³n'}`,
phase: `${isUp?'Tendencia alcista':'Fase de ajuste'}, precio ${isUp?'rompe':'cae'} MA clave, volumen ${data.volume>50000000?'expandiendo':'contrayendo'}, MACD ${isUp?'cruce dorado':'cruce mortal'}, RSI ${isUp?'70 sobrecompra':'35 sobreventa'}`,
shortTerm: `Corto(1-4sem): Objetivo $${(p*(isUp?1.08:0.95)).toFixed(2)}-$${(p*(isUp?1.12:0.98)).toFixed(2)}. ${isUp?'AÃ±adir 30% en $'+(p*0.97).toFixed(2):'Stop en $'+(p*0.93).toFixed(2)}. Stop $${(p*(isUp?0.93:0.88)).toFixed(2)}. PosiciÃ³n ${isUp?'70%':'30%'}`,
midTerm: `Medio(1-3m): Objetivo $${(p*(isUp?1.18:0.88)).toFixed(2)}-$${(p*(isUp?1.25:0.92)).toFixed(2)}. PrÃ³ximos resultados ${isUp?'superarÃ¡n':'no alcanzarÃ¡n'}. ${isUp?'Mantener 60% nÃºcleo, 40% trading':'Ligero 20%, aÃ±adir en $'+(p*0.85).toFixed(2)}. Seguir resultados, competencia, polÃ­tica`,
longTerm: `Largo(3-12m): Objetivo $${(p*(isUp?1.35:0.75)).toFixed(2)}-$${(p*(isUp?1.50:0.85)).toFixed(2)}. ${isUp?'LÃ­der industria, foso fuerte, alta certeza':'PresiÃ³n corta pero fundamentales intactos, valoraciÃ³n baja'}. NÃºcleo ${isUp?'50%':'20%'}, trading 20%, efectivo ${isUp?'30%':'60%'}. Observar innovaciÃ³n, cuota, polÃ­tica, macro`,
buyPoints: [
`Compra1: $${(p*0.95).toFixed(2)}-$${(p*0.97).toFixed(2)} | MA 10 dÃ­as, RSI 50-60, MACD rojo acortando | AÃ±adir 20-30% | Stop $${(p*0.92).toFixed(2)}`,
`Compra2: $${(p*0.88).toFixed(2)}-$${(p*0.92).toFixed(2)} | MA 30 dÃ­as, sobreventa, volumen contrayendo | AÃ±adir 30-40% por lotes | Stop $${(p*0.85).toFixed(2)}`,
`Compra3: $${(p*0.75).toFixed(2)}-$${(p*0.82).toFixed(2)} | ValoraciÃ³n baja, fundamentales intactos, lÃ³gica mantiene | 50-60% en 3-6m | Mantener largo sin stop`
],
sellPoints: [
`Venta1: $${(p*1.08).toFixed(2)}-$${(p*1.12).toFixed(2)} | Romper mÃ¡ximo, RSI>70, MACD diverge | Vender 30% asegurar beneficio | TÃ©cnico sobrecalentado`,
`Venta2: $${(p*1.20).toFixed(2)}-$${(p*1.28).toFixed(2)} | Post-resultados recuperaciÃ³n, sentimiento alto | Vender 40% mantener nÃºcleo | ValoraciÃ³n refleja alza`,
`Venta3: $${(p*1.40).toFixed(2)}-$${(p*1.55).toFixed(2)} | Objetivo largo alcanzado, punto inflexiÃ³n fundamental/tÃ©cnico | Reducir a 20-30% | PrevenciÃ³n riesgo sistÃ©mico`
],
supports: [
`Soporte1: $${(p*0.95).toFixed(2)} | MA 10 dÃ­as, Ã¡rea densa, Fib 0.382 | Fuerte 30% romper | Puede aÃ±adir`,
`Soporte2: $${(p*0.88).toFixed(2)} | MA 30 dÃ­as, base plataforma, Fib 0.618 | Fuerte 15% romper | Compra media`
],
resistances: [
`Resistencia1: $${(p*1.08).toFixed(2)} | MÃ¡ximo previo, canal superior, nÃºmero redondo | Media 45% romper | Puede perseguir`,
`Resistencia2: $${(p*1.18).toFixed(2)} | MÃ¡ximo histÃ³rico, trading denso, lÃ­nea cuello | Fuerte 25% romper | Necesita volumen`
],
risks: [
`Riesgo1: Riesgo SistÃ©mico Mercado | Subidas Fed exceden, liquidez se ajusta, tech bajo presiÃ³n | Prob 35% | Impacto -10 a -15% | Reducir a <50%, observar Fed`,
`Riesgo2: Competencia Industria | Nuevo participante irrumpe o competidor gana cuota, compresiÃ³n margen | Prob 30% | Impacto crecimiento -5 a -10% | Monitorear competidores y cuota mercado`,
`Riesgo3: Deterioro Fundamental | I+D producto bajo expectativas o pÃ©rdida cliente importante, caÃ­da ingresos | Prob 20% | Impacto valoraciÃ³n -15 a -20% | Seguir resultados trimestrales y guÃ­a`
],
expectedGains: { short: isUp?'+8%':'-5%', mid: isUp?'+18%':'+8%', long: isUp?'+35%':'+25%' }
};
} else {
return {
summary: `${symbol} in ${isUp?'uptrend':'correction'}, technical ${isUp?'strong':'weak'}, suggest ${isUp?'hold watch pullback':'wait for stabilization'}`,
phase: `${isUp?'Uptrend':'Correction'}, price ${isUp?'breaks above':'falls below'} key MAs, volume ${data.volume>50000000?'expanding':'contracting'}, MACD ${isUp?'golden cross':'death cross'}, RSI ${isUp?'70 overbought':'35 oversold'}`,
shortTerm: `Short(1-4w): Target $${(p*(isUp?1.08:0.95)).toFixed(2)}-$${(p*(isUp?1.12:0.98)).toFixed(2)}. ${isUp?'Add 30% at $'+(p*0.97).toFixed(2):'Stop at $'+(p*0.93).toFixed(2)}. Set stop $${(p*(isUp?0.93:0.88)).toFixed(2)}. ${isUp?'70%':'30%'} position`,
midTerm: `Mid(1-3m): Target $${(p*(isUp?1.18:0.88)).toFixed(2)}-$${(p*(isUp?1.25:0.92)).toFixed(2)}. Next earnings expect ${isUp?'beat':'miss'}. ${isUp?'Hold 60% core, 40% trade':'Light 20%, add at $'+(p*0.85).toFixed(2)}. Track earnings, competitors, policy`,
longTerm: `Long(3-12m): Target $${(p*(isUp?1.35:0.75)).toFixed(2)}-$${(p*(isUp?1.50:0.85)).toFixed(2)}. ${isUp?'Industry leader, strong moat, high certainty':'Short pressure but fundamentals intact, valuation low'}. Core ${isUp?'50%':'20%'}, trade 20%, cash ${isUp?'30%':'60%'}. Watch innovation, share, policy, macro`,
buyPoints: [
`Buy1: $${(p*0.95).toFixed(2)}-$${(p*0.97).toFixed(2)} | 10-day MA, RSI 50-60, MACD red shortening | Add 20-30% | Stop $${(p*0.92).toFixed(2)}`,
`Buy2: $${(p*0.88).toFixed(2)}-$${(p*0.92).toFixed(2)} | 30-day MA, oversold, volume contracting | Add 30-40% batches | Stop $${(p*0.85).toFixed(2)}`,
`Buy3: $${(p*0.75).toFixed(2)}-$${(p*0.82).toFixed(2)} | Valuation low, fundamentals intact, logic holds | 50-60% over 3-6m | No stop long hold`
],
sellPoints: [
`Sell1: $${(p*1.08).toFixed(2)}-$${(p*1.12).toFixed(2)} | Break high, RSI>70, MACD diverge | Sell 30% lock profit | Technical overbought`,
`Sell2: $${(p*1.20).toFixed(2)}-$${(p*1.28).toFixed(2)} | Post-earnings recovery, sentiment high | Sell 40% keep core | Valuation reflects upside`,
`Sell3: $${(p*1.40).toFixed(2)}-$${(p*1.55).toFixed(2)} | Long target reached, fundamental/technical inflection | Reduce to 20-30% | Systemic risk prevention`
],
supports: [
`Support1: $${(p*0.95).toFixed(2)} | 10-day MA, dense area, 0.382 Fib | Strong 30% break | Can add`,
`Support2: $${(p*0.88).toFixed(2)} | 30-day MA, platform bottom, 0.618 Fib | Strong 15% break | Mid buy`
],
resistances: [
`Resistance1: $${(p*1.08).toFixed(2)} | Previous high, channel top, round number | Medium 45% break | Can chase`,
`Resistance2: $${(p*1.18).toFixed(2)} | Historical high, dense trading, neckline | Strong 25% break | Need volume`
],
risks: [
`Risk1: Market Systematic | Fed rate hikes exceed, liquidity tightens, tech under pressure | Prob 35% | Impact -10 to -15% | Reduce to <50%, watch Fed`,
`Risk2: Industry Competition | New entrant breakthrough or competitor gains share, margin compression | Prob 30% | Impact growth -5 to -10% | Monitor competitors and market share`,
`Risk3: Fundamental Deterioration | Product R&D below expectations or major customer loss, revenue decline | Prob 20% | Impact valuation -15 to -20% | Track quarterly results and guidance`
],
expectedGains: { short: isUp?'+8%':'-5%', mid: isUp?'+18%':'+8%', long: isUp?'+35%':'+25%' }
};
}
}

function viewDetail(idx) {
const t = translations[currentLang];
const analyses = JSON.parse(localStorage.getItem('stockAnalyses') || '[]');
const item = analyses[idx];
if (!item) return;

const d = item.data || {};
// é‡æ–°ç”Ÿæˆåˆ†æå†…å®¹ï¼Œä½¿ç”¨å½“å‰è¯­è¨€
const a = generateAnalysis(item.symbol, d, currentLang);
const holdings = JSON.parse(localStorage.getItem('stockHoldings') || '{}');
const holding = holdings[item.symbol];
const p = d.price || 0;
const isUp = (d.change || 0) >= 0;

// Build holding info HTML
let holdingHtml = '';
if (holding) {
const pnl = ((p - holding.cost) / holding.cost * 100);
const pnlAmount = (p - holding.cost) * holding.shares;
const pnlClass = pnl >= 0 ? 'profit' : 'loss';
const pnlSign = pnl >= 0 ? '+' : '';
const totalCost = holding.cost * holding.shares;

holdingHtml = `
<div style="background:#f0f9ff;border-left:4px solid #3b82f6;padding:15px;margin:15px 0;border-radius:8px">
ğŸ’¼ ${t.holding}: ${t.cost}$${holding.cost} | ${t.shares}${holding.shares}è‚¡ | <span class="${pnlClass}">${pnlSign}${pnl.toFixed(2)}% ($${pnlSign}${pnlAmount.toFixed(0)})</span>
</div>
`;
}

// Build support/resistance levels
let levelsHtml = '';
if ((a.supports && a.supports.length > 0) || (a.resistances && a.resistances.length > 0)) {
levelsHtml = `
<div style="margin:20px 0">
<h3 style="color:#667eea;font-size:18px;margin-bottom:15px">ğŸ“ ${t.keyLevels}</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
${(a.supports || []).map((s, i) => `
<div style="background:#f8f9fa;padding:12px;border-radius:8px;border-left:4px solid #10b981">
<div style="font-size:12px;font-weight:600;color:#666;margin-bottom:5px">${t.support} ${i+1}</div>
<div style="font-size:14px;color:#1a1a1a;white-space:pre-line">${s}</div>
</div>
`).join('')}
${(a.resistances || []).map((r, i) => `
<div style="background:#f8f9fa;padding:12px;border-radius:8px;border-left:4px solid #ef4444">
<div style="font-size:12px;font-weight:600;color:#666;margin-bottom:5px">${t.resistance} ${i+1}</div>
<div style="font-size:14px;color:#1a1a1a;white-space:pre-line">${r}</div>
</div>
`).join('')}
</div>
</div>
`;
}

// Build buy plan
let buyPlanHtml = '';
if (a.buyPoints && a.buyPoints.length > 0) {
buyPlanHtml = `
<div style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:25px;border-radius:15px;margin:20px 0">
<h3 style="color:#fff;font-size:20px;margin-bottom:20px;text-align:center">ğŸ¯ ${t.buyPoints}</h3>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px">
${a.buyPoints.slice(0, 3).map((bp, i) => {
const label = currentLang === 'zh' ? ['çŸ­æœŸæœºä¼š(1å‘¨)', 'ä¸­æœŸæœºä¼š(1æœˆ)', 'æ³¢æ®µç­–ç•¥'][i] :
currentLang === 'es' ? ['Oportunidad Corta(1sem)', 'Oportunidad Media(1m)', 'Estrategia'][i] :
['Short Opportunity(1w)', 'Mid Opportunity(1m)', 'Swing Strategy'][i];
return `
<div style="background:#fff;padding:15px;border-radius:10px">
<div style="font-size:14px;font-weight:700;color:#10b981;margin-bottom:8px">${label}</div>
<div style="font-size:14px;color:#333;line-height:1.5;white-space:pre-line">${bp}</div>
</div>
`;
}).join('')}
</div>
</div>
`;
}

// Build sell plan
let sellPlanHtml = '';
if (a.sellPoints && a.sellPoints.length > 0) {
sellPlanHtml = `
<div style="background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);padding:25px;border-radius:15px;margin:20px 0">
<h3 style="color:#fff;font-size:20px;margin-bottom:20px;text-align:center">ğŸ”¤ ${t.sellPoints}</h3>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px">
${a.sellPoints.slice(0, 3).map((sp, i) => {
const timeLabel = currentLang === 'zh' ? ['çŸ­æœŸ(1-4å‘¨)', 'ä¸­æœŸ(1-3æœˆ)', 'é•¿æœŸ(3-12æœˆ)'][i] :
currentLang === 'es' ? ['Corto(1-4sem)', 'Medio(1-3m)', 'Largo(3-12m)'][i] :
['Short(1-4w)', 'Mid(1-3m)', 'Long(3-12m)'][i];
return `
<div style="background:#fff;padding:15px;border-radius:10px">
<div style="font-size:14px;font-weight:700;color:#f59e0b;margin-bottom:5px">${timeLabel}</div>
<div style="font-size:14px;color:#333;line-height:1.4;white-space:pre-line">${sp}</div>
</div>
`;
}).join('')}
</div>
</div>
`;
}

// Build additional sections
let sectionsHtml = '';
if (a.phase) {
sectionsHtml += `<div style="margin:15px 0;padding:12px;background:#f8f9fa;border-radius:8px"><strong style="color:#667eea">ğŸ“ˆ ${t.phase}:</strong> ${a.phase}</div>`;
}
if (a.shortTerm) {
sectionsHtml += `<div style="margin:15px 0;padding:12px;background:#f8f9fa;border-radius:8px"><strong style="color:#667eea">ğŸ“Š ${t.shortTerm}:</strong> ${a.shortTerm}</div>`;
}
if (a.midTerm) {
sectionsHtml += `<div style="margin:15px 0;padding:12px;background:#f8f9fa;border-radius:8px"><strong style="color:#667eea">ğŸ“… ${t.midTerm}:</strong> ${a.midTerm}</div>`;
}
if (a.longTerm) {
sectionsHtml += `<div style="margin:15px 0;padding:12px;background:#f8f9fa;border-radius:8px"><strong style="color:#667eea">ğŸš€ ${t.longTerm}:</strong> ${a.longTerm}</div>`;
}

// Build risks
let risksHtml = '';
if (a.risks && a.risks.length > 0) {
risksHtml = a.risks.map(risk => `
<div style="background:#fef2f2;border-left:4px solid #ef4444;padding:15px;border-radius:8px;margin:15px 0">
<strong>âš ï¸ ${currentLang === 'zh' ? 'æ ¸å¿ƒé£é™©' : currentLang === 'es' ? 'Riesgo Principal' : 'Core Risk'}:</strong> ${risk}
</div>
`).join('');
}

// Build expected gains
let expectedGainsHtml = '';
if (a.expectedGains) {
const gainsLabel = currentLang === 'zh' ? 'é¢„æœŸæ¶¨å¹…' : currentLang === 'es' ? 'Ganancias Esperadas' : 'Expected Gains';
const shortLabel = currentLang === 'zh' ? 'çŸ­æœŸ' : currentLang === 'es' ? 'Corto' : 'Short';
const midLabel = currentLang === 'zh' ? 'ä¸­æœŸ' : currentLang === 'es' ? 'Medio' : 'Mid';
const longLabel = currentLang === 'zh' ? 'é•¿æœŸ' : currentLang === 'es' ? 'Largo' : 'Long';
expectedGainsHtml = `
<div style="background:#e8f5e9;border-left:4px solid #10b981;padding:15px;border-radius:8px;margin:15px 0">
<strong>ğŸ“ˆ ${gainsLabel}:</strong> ${shortLabel}: ${a.expectedGains.short}, ${midLabel}: ${a.expectedGains.mid}, ${longLabel}: ${a.expectedGains.long}
</div>
`;
}

// Build action recommendations
let actionsHtml = '';
if (a.expectedGains) {
const aggressiveLabel = currentLang === 'zh' ? 'æ¿€è¿›å‹' : currentLang === 'es' ? 'Agresivo' : 'Aggressive';
const neutralLabel = currentLang === 'zh' ? 'ä¸­æ€§å‹' : currentLang === 'es' ? 'Neutral' : 'Neutral';
const conservativeLabel = currentLang === 'zh' ? 'ä¿å®ˆå‹' : currentLang === 'es' ? 'Conservador' : 'Conservative';
const holdLabel = currentLang === 'zh' ? 'æŒæœ‰å¾…æ¶¨' : currentLang === 'es' ? 'Mantener' : 'Hold';
const partialSellLabel = currentLang === 'zh' ? 'éƒ¨åˆ†å‡ä»“30%' : currentLang === 'es' ? 'Vender 30%' : 'Sell 30%';
const majorSellLabel = currentLang === 'zh' ? 'å‡ä»“50%é”å®šåˆ©æ¶¦' : currentLang === 'es' ? 'Vender 50%' : 'Sell 50%';

actionsHtml = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:20px 0">
<div style="background:#667eea;color:#fff;padding:15px;border-radius:12px;text-align:center">
<div style="font-size:12px;opacity:0.9;margin-bottom:5px">${aggressiveLabel}</div>
<div style="font-size:16px;font-weight:bold">${holdLabel}</div>
</div>
<div style="background:#f59e0b;color:#fff;padding:15px;border-radius:12px;text-align:center">
<div style="font-size:12px;opacity:0.9;margin-bottom:5px">${neutralLabel}</div>
<div style="font-size:16px;font-weight:bold">${partialSellLabel}</div>
</div>
<div style="background:#10b981;color:#fff;padding:15px;border-radius:12px;text-align:center">
<div style="font-size:12px;opacity:0.9;margin-bottom:5px">${conservativeLabel}</div>
<div style="font-size:16px;font-weight:bold">${majorSellLabel}</div>
</div>
</div>
`;
}

document.getElementById('modalTitle').textContent = `${item.symbol} ${t.modalTitle}`;
document.getElementById('modalBody').innerHTML = `
<div class="space-y-4">
<!-- Header with price -->
<div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:20px;border-bottom:3px solid #667eea;margin-bottom:20px">
<div style="font-size:36px;font-weight:bold;color:#667eea">${item.symbol}</div>
<div style="text-align:right">
<div style="font-size:36px;font-weight:bold">$${p.toFixed(2)}</div>
<div style="font-size:20px;font-weight:600;color:${isUp ? '#10b981' : '#ef4444'}">${isUp ? '+' : ''}${d.changePercent || 'N/A'}</div>
</div>
</div>

<!-- Holding info -->
${holdingHtml}

<!-- Summary -->
<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:12px;text-align:center;font-size:18px;font-weight:600;margin:20px 0">
ğŸ’¡ ${a.summary || ''}
</div>

<!-- Support/Resistance levels -->
${levelsHtml}

<!-- Buy plan -->
${buyPlanHtml}

<!-- Sell plan -->
${sellPlanHtml}

<!-- Additional sections -->
${sectionsHtml}

<!-- Expected gains -->
${expectedGainsHtml}

<!-- Risks -->
${risksHtml}

<!-- Action recommendations -->
${actionsHtml}

<!-- Analysis time -->
<div style="text-align:center;color:#999;margin-top:20px;padding-top:20px;border-top:2px solid #e0e0e0;font-size:12px">
${t.analysisTime}: ${item.date}
</div>
</div>
`;

document.getElementById('modal').classList.add('show');
document.body.style.overflow = 'hidden';
}

async function downloadReport(idx) {
const t = translations[currentLang];
const analyses = JSON.parse(localStorage.getItem('stockAnalyses') || '[]');
const item = analyses[idx];
if (!item) return;

const d = item.data || {};
const a = generateAnalysis(item.symbol, d, currentLang);
const holdings = JSON.parse(localStorage.getItem('stockHoldings') || '{}');
const holding = holdings[item.symbol];
const p = d.price || 0;
const isUp = (d.change || 0) >= 0;

// åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥æ¸²æŸ“æŠ¥å‘Š
const reportContainer = document.createElement('div');
reportContainer.style.position = 'absolute';
reportContainer.style.left = '-9999px';
reportContainer.style.width = '800px';
reportContainer.style.background = '#fff';
reportContainer.style.padding = '40px';
reportContainer.style.fontFamily = 'Arial, sans-serif';

// æ„å»ºæŒä»“ä¿¡æ¯
let holdingHtml = '';
if (holding) {
const pnl = ((p - holding.cost) / holding.cost * 100);
const pnlAmount = (p - holding.cost) * holding.shares;
const pnlClass = pnl >= 0 ? 'color:#10b981' : 'color:#ef4444';
const pnlSign = pnl >= 0 ? '+' : '';

holdingHtml = `
<div style="background:#f0f9ff;border-left:4px solid #3b82f6;padding:15px;margin:15px 0;border-radius:8px">
ğŸ’¼ ${t.holding}: ${t.cost}$${holding.cost} | ${t.shares}${holding.shares}è‚¡ | <span style="${pnlClass};font-weight:bold">${pnlSign}${pnl.toFixed(2)}% ($${pnlSign}${pnlAmount.toFixed(0)})</span>
</div>
`;
}

// æ„å»ºå®Œæ•´çš„HTMLå†…å®¹
reportContainer.innerHTML = `
<div style="max-width:800px;margin:0 auto">
<h1 style="text-align:center;color:#667eea;margin-bottom:20px">${item.symbol} ${t.modalTitle}</h1>
<div style="text-align:center;margin-bottom:30px">
<div style="display:inline-block;text-align:left">
<div style="font-size:36px;font-weight:bold;color:#667eea">${item.symbol}</div>
<div style="font-size:36px;font-weight:bold">$${p.toFixed(2)}</div>
<div style="font-size:20px;font-weight:600;color:${isUp ? '#10b981' : '#ef4444'}">${isUp ? '+' : ''}${d.changePercent || 'N/A'}</div>
</div>
</div>

${holdingHtml}

<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:12px;text-align:center;font-size:16px;font-weight:600;margin:20px 0">
ğŸ’¡ ${a.summary || ''}
</div>

${(a.supports || a.resistances) ? `
<div style="margin:20px 0">
<h3 style="color:#667eea;font-size:18px;margin-bottom:15px">ğŸ“ ${t.keyLevels}</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
${(a.supports || []).map((s, i) => `
<div style="background:#f8f9fa;padding:12px;border-radius:8px;border-left:4px solid #10b981">
<div style="font-size:12px;font-weight:600;color:#666;margin-bottom:5px">${t.support} ${i+1}</div>
<div style="font-size:13px;color:#1a1a1a">${s}</div>
</div>
`).join('')}
${(a.resistances || []).map((r, i) => `
<div style="background:#f8f9fa;padding:12px;border-radius:8px;border-left:4px solid #ef4444">
<div style="font-size:12px;font-weight:600;color:#666;margin-bottom:5px">${t.resistance} ${i+1}</div>
<div style="font-size:13px;color:#1a1a1a">${r}</div>
</div>
`).join('')}
</div>
</div>
` : ''}

${a.buyPoints && a.buyPoints.length > 0 ? `
<div style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:20px;border-radius:15px;margin:20px 0">
<h3 style="color:#fff;font-size:18px;margin-bottom:15px;text-align:center">ğŸ¯ ${t.buyPoints}</h3>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
${a.buyPoints.slice(0, 3).map((bp, i) => `
<div style="background:#fff;padding:12px;border-radius:10px">
<div style="font-size:13px;font-weight:700;color:#10b981;margin-bottom:5px">${i === 0 ? (currentLang === 'zh' ? 'çŸ­æœŸæœºä¼š' : currentLang === 'es' ? 'Corto' : 'Short') : i === 1 ? (currentLang === 'zh' ? 'ä¸­æœŸæœºä¼š' : currentLang === 'es' ? 'Medio' : 'Mid') : (currentLang === 'zh' ? 'æ³¢æ®µç­–ç•¥' : currentLang === 'es' ? 'Estrategia' : 'Swing')}</div>
<div style="font-size:12px;color:#333;line-height:1.4">${bp}</div>
</div>
`).join('')}
</div>
</div>
` : ''}

${a.sellPoints && a.sellPoints.length > 0 ? `
<div style="background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);padding:20px;border-radius:15px;margin:20px 0">
<h3 style="color:#fff;font-size:18px;margin-bottom:15px;text-align:center">ğŸ”¤ ${t.sellPoints}</h3>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
${a.sellPoints.slice(0, 3).map((sp, i) => `
<div style="background:#fff;padding:12px;border-radius:10px">
<div style="font-size:13px;font-weight:700;color:#f59e0b;margin-bottom:5px">${i === 0 ? (currentLang === 'zh' ? 'çŸ­æœŸ' : currentLang === 'es' ? 'Corto' : 'Short') : i === 1 ? (currentLang === 'zh' ? 'ä¸­æœŸ' : currentLang === 'es' ? 'Medio' : 'Mid') : (currentLang === 'zh' ? 'é•¿æœŸ' : currentLang === 'es' ? 'Largo' : 'Long')}</div>
<div style="font-size:12px;color:#333;line-height:1.4">${sp}</div>
</div>
`).join('')}
</div>
</div>
` : ''}

${a.risks && a.risks.length > 0 ? a.risks.map(risk => `
<div style="background:#fef2f2;border-left:4px solid #ef4444;padding:15px;border-radius:8px;margin:15px 0">
<strong>âš ï¸ ${currentLang === 'zh' ? 'æ ¸å¿ƒé£é™©' : currentLang === 'es' ? 'Riesgo' : 'Core Risk'}:</strong> ${risk}
</div>
`).join('') : ''}

${a.expectedGains ? `
<div style="background:#e8f5e9;border-left:4px solid #10b981;padding:15px;border-radius:8px;margin:15px 0">
<strong>ğŸ“ˆ ${currentLang === 'zh' ? 'é¢„æœŸæ¶¨å¹…' : currentLang === 'es' ? 'Ganancias' : 'Expected Gains'}:</strong> 
${currentLang === 'zh' ? 'çŸ­æœŸ' : currentLang === 'es' ? 'Corto' : 'Short'}: ${a.expectedGains.short}, 
${currentLang === 'zh' ? 'ä¸­æœŸ' : currentLang === 'es' ? 'Medio' : 'Mid'}: ${a.expectedGains.mid}, 
${currentLang === 'zh' ? 'é•¿æœŸ' : currentLang === 'es' ? 'Largo' : 'Long'}: ${a.expectedGains.long}
</div>
` : ''}

<div style="text-align:center;color:#999;margin-top:30px;padding-top:20px;border-top:2px solid #e0e0e0;font-size:12px">
${t.analysisTime}: ${item.date}
</div>
</div>
`;

document.body.appendChild(reportContainer);

try {
// ä½¿ç”¨ html2canvas å°†å®¹å™¨è½¬æ¢ä¸ºcanvas
const canvas = await html2canvas(reportContainer, {
scale: 2,
useCORS: true,
logging: false,
backgroundColor: '#ffffff'
});

// åˆ›å»ºPDF
const { jsPDF } = window.jspdf;
const pdf = new jsPDF({
orientation: 'portrait',
unit: 'mm',
format: 'a4'
});

// è®¡ç®—å›¾ç‰‡å°ºå¯¸ä»¥é€‚åº”A4é¡µé¢
const imgWidth = 210; // A4å®½åº¦ï¼ˆmmï¼‰
const imgHeight = (canvas.height * imgWidth) / canvas.width;
const imgData = canvas.toDataURL('image/png');

// å¦‚æœå†…å®¹è¶…è¿‡ä¸€é¡µï¼Œéœ€è¦åˆ†é¡µ
let heightLeft = imgHeight;
let position = 0;

pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
heightLeft -= 297; // A4é«˜åº¦

while (heightLeft >= 0) {
position = heightLeft - imgHeight;
pdf.addPage();
pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
heightLeft -= 297;
}

// ä¿å­˜PDF
const fileName = `${item.symbol}_${currentLang === 'zh' ? 'åˆ†ææŠ¥å‘Š' : currentLang === 'es' ? 'Informe' : 'Report'}_${new Date().toISOString().split('T')[0]}.pdf`;
pdf.save(fileName);

const msg = currentLang === 'zh' ? 'PDFæŠ¥å‘Šå·²ä¸‹è½½' : currentLang === 'es' ? 'PDF descargado' : 'PDF downloaded';
alert(`âœ… ${msg}!`);

} catch (error) {
console.error('PDF generation error:', error);
const errMsg = currentLang === 'zh' ? 'PDFç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•' : currentLang === 'es' ? 'Error al generar PDF' : 'PDF generation failed';
alert(`âŒ ${errMsg}`);
} finally {
// æ¸…ç†ä¸´æ—¶å®¹å™¨
document.body.removeChild(reportContainer);
}
}

function closeModal() {
document.getElementById('modal').classList.remove('show');
document.body.style.overflow = '';
}

document.getElementById('modal').addEventListener('click', e => {
if (e.target.id === 'modal') closeModal();
});

document.addEventListener('keydown', e => {
if (e.key === 'Escape') closeModal();
});

const params = new URLSearchParams(window.location.search);
const symbol = params.get('symbol');

applyLanguage();
loadHistory();

if (symbol) {
const analyses = JSON.parse(localStorage.getItem('stockAnalyses') || '[]');
const idx = analyses.findIndex(a => a.symbol === symbol);
if (idx >= 0) setTimeout(() => viewDetail(idx), 500);
}
</script>

</body>
</html>
